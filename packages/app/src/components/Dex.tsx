'use client'

import React, { useCallback, useState } from 'react'
import { Address, useAccount, useBalance, usePublicClient, useWalletClient } from 'wagmi'
import { getUsdc, usdcABI } from '@/abis'
import { formatEther, getContractAddress, parseEther, parseUnits } from 'viem'
import { getBlockNumber, getTransactionCount } from 'viem/actions'

export function Dex() {
  const { address, isConnecting, isDisconnected } = useAccount()
  const { data: walletClient, isError, isLoading } = useWalletClient()
  const publicClient = usePublicClient()

  // const [token1Address, setToken1Address] = React.useState('0x5B1F61B316baaE16E55b497258D40D62E222A049')
  // const [token2Address, setToken2Address] = React.useState('0xa72609480b99D71B29326F6267e7c0EC649de093')
  const token1Address = '0x5B1F61B316baaE16E55b497258D40D62E222A049'
  const token2Address = '0xa72609480b99D71B29326F6267e7c0EC649de093'
  const uniswapRouter = '0x0BBDfB697D515EF154628d659724C58d8e0D5CDC'

  const [token1Input, setToken1Input] = useState(0)
  const [token2Input, setToken2Input] = useState(0)

  const handleToken1InputChange = (event) => {
    setToken1Input(event.target.value)
  }

  const handleToken2InputChange = (event) => {
    setToken2Input(event.target.value)
  }

  const token1Balance = useBalance({
    address: address,
    token: token1Address as Address,
    watch: true,
  })

  const token2Balance = useBalance({
    address: address,
    token: token2Address as Address,
    watch: true,
  })

  // const deployToken:
  //   | React.MouseEventHandler<HTMLButtonElement>
  //   | ((index: number) => React.MouseEventHandler<HTMLButtonElement>) = useCallback(
  //   (index: number) => async () => {
  //     console.log('Deploying ERC20 token')
  //     console.log('Deployer account: ' + address)
  //     if (walletClient != undefined && address != undefined) {
  //       const hash = await walletClient.deployContract({
  //         abi: usdcABI,
  //         account: address,
  //         bytecode:
  //           '0x60806040523480156200001157600080fd5b506040805180820182526004808252635553444360e01b60208084018290528451808601909552918452908301529060036200004e83826200017b565b5060046200005d82826200017b565b5050506200007a620000746200008060201b60201c565b62000084565b62000247565b3390565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200010157607f821691505b6020821081036200012257634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156200017657600081815260208120601f850160051c81016020861015620001515750805b601f850160051c820191505b8181101562000172578281556001016200015d565b5050505b505050565b81516001600160401b03811115620001975762000197620000d6565b620001af81620001a88454620000ec565b8462000128565b602080601f831160018114620001e75760008415620001ce5750858301515b600019600386901b1c1916600185901b17855562000172565b600085815260208120601f198616915b828110156200021857888601518255948401946001909101908401620001f7565b5085821015620002375787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b610d6380620002576000396000f3fe608060405234801561001057600080fd5b506004361061011b5760003560e01c806370a08231116100b257806395d89b4111610081578063a9059cbb11610066578063a9059cbb1461024a578063dd62ed3e1461025d578063f2fde38b1461029657600080fd5b806395d89b411461022f578063a457c2d71461023757600080fd5b806370a08231146101d0578063715018a6146101f957806379cc6790146102015780638da5cb5b1461021457600080fd5b8063313ce567116100ee578063313ce56714610186578063395093511461019557806340c10f19146101a857806342966c68146101bd57600080fd5b806306fdde0314610120578063095ea7b31461013e57806318160ddd1461016157806323b872dd14610173575b600080fd5b6101286102a9565b6040516101359190610b94565b60405180910390f35b61015161014c366004610bfe565b61033b565b6040519015158152602001610135565b6002545b604051908152602001610135565b610151610181366004610c28565b610355565b60405160068152602001610135565b6101516101a3366004610bfe565b610379565b6101bb6101b6366004610bfe565b6103b8565b005b6101bb6101cb366004610c64565b6103ce565b6101656101de366004610c7d565b6001600160a01b031660009081526020819052604090205490565b6101bb6103db565b6101bb61020f366004610bfe565b6103ef565b6005546040516001600160a01b039091168152602001610135565b610128610404565b610151610245366004610bfe565b610413565b610151610258366004610bfe565b6104c2565b61016561026b366004610c9f565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6101bb6102a4366004610c7d565b6104d0565b6060600380546102b890610cd2565b80601f01602080910402602001604051908101604052809291908181526020018280546102e490610cd2565b80156103315780601f1061030657610100808354040283529160200191610331565b820191906000526020600020905b81548152906001019060200180831161031457829003601f168201915b5050505050905090565b60003361034981858561055d565b60019150505b92915050565b600033610363858285610682565b61036e858585610714565b506001949350505050565b3360008181526001602090815260408083206001600160a01b038716845290915281205490919061034990829086906103b3908790610d0c565b61055d565b6103c06108e7565b6103ca8282610941565b5050565b6103d83382610a00565b50565b6103e36108e7565b6103ed6000610b2a565b565b6103fa823383610682565b6103ca8282610a00565b6060600480546102b890610cd2565b3360008181526001602090815260408083206001600160a01b0387168452909152812054909190838110156104b55760405162461bcd60e51b815260206004820152602560248201527f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760448201527f207a65726f00000000000000000000000000000000000000000000000000000060648201526084015b60405180910390fd5b61036e828686840361055d565b600033610349818585610714565b6104d86108e7565b6001600160a01b0381166105545760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201527f646472657373000000000000000000000000000000000000000000000000000060648201526084016104ac565b6103d881610b2a565b6001600160a01b0383166105bf5760405162461bcd60e51b8152602060048201526024808201527f45524332303a20617070726f76652066726f6d20746865207a65726f206164646044820152637265737360e01b60648201526084016104ac565b6001600160a01b0382166106205760405162461bcd60e51b815260206004820152602260248201527f45524332303a20617070726f766520746f20746865207a65726f206164647265604482015261737360f01b60648201526084016104ac565b6001600160a01b0383811660008181526001602090815260408083209487168084529482529182902085905590518481527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591015b60405180910390a3505050565b6001600160a01b03838116600090815260016020908152604080832093861683529290522054600019811461070e57818110156107015760405162461bcd60e51b815260206004820152601d60248201527f45524332303a20696e73756666696369656e7420616c6c6f77616e636500000060448201526064016104ac565b61070e848484840361055d565b50505050565b6001600160a01b0383166107905760405162461bcd60e51b815260206004820152602560248201527f45524332303a207472616e736665722066726f6d20746865207a65726f20616460448201527f647265737300000000000000000000000000000000000000000000000000000060648201526084016104ac565b6001600160a01b0382166107f25760405162461bcd60e51b815260206004820152602360248201527f45524332303a207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b60648201526084016104ac565b6001600160a01b038316600090815260208190526040902054818110156108815760405162461bcd60e51b815260206004820152602660248201527f45524332303a207472616e7366657220616d6f756e742065786365656473206260448201527f616c616e6365000000000000000000000000000000000000000000000000000060648201526084016104ac565b6001600160a01b03848116600081815260208181526040808320878703905593871680835291849020805487019055925185815290927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef910160405180910390a361070e565b6005546001600160a01b031633146103ed5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016104ac565b6001600160a01b0382166109975760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f20616464726573730060448201526064016104ac565b80600260008282546109a99190610d0c565b90915550506001600160a01b038216600081815260208181526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef910160405180910390a35050565b6001600160a01b038216610a605760405162461bcd60e51b815260206004820152602160248201527f45524332303a206275726e2066726f6d20746865207a65726f206164647265736044820152607360f81b60648201526084016104ac565b6001600160a01b03821660009081526020819052604090205481811015610ad45760405162461bcd60e51b815260206004820152602260248201527f45524332303a206275726e20616d6f756e7420657863656564732062616c616e604482015261636560f01b60648201526084016104ac565b6001600160a01b0383166000818152602081815260408083208686039055600280548790039055518581529192917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9101610675565b600580546001600160a01b038381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600060208083528351808285015260005b81811015610bc157858101830151858201604001528201610ba5565b506000604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b0381168114610bf957600080fd5b919050565b60008060408385031215610c1157600080fd5b610c1a83610be2565b946020939093013593505050565b600080600060608486031215610c3d57600080fd5b610c4684610be2565b9250610c5460208501610be2565b9150604084013590509250925092565b600060208284031215610c7657600080fd5b5035919050565b600060208284031215610c8f57600080fd5b610c9882610be2565b9392505050565b60008060408385031215610cb257600080fd5b610cbb83610be2565b9150610cc960208401610be2565b90509250929050565b600181811c90821680610ce657607f821691505b602082108103610d0657634e487b7160e01b600052602260045260246000fd5b50919050565b8082018082111561034f57634e487b7160e01b600052601160045260246000fdfea26469706673582212206d85558b98269e02a87852eb23ca78bc9268549407895ea86995ab2a30e00a5d64736f6c63430008130033',
  //       })
  //       console.log(hash)
  //
  //       const tokenAddress = getContractAddress({
  //         from: address,
  //         nonce: BigInt(
  //           await getTransactionCount(walletClient, {
  //             address: address,
  //             blockTag: 'latest',
  //           })
  //         ),
  //       })
  //       console.log('Token address: ' + tokenAddress)
  //       if (index == 1) setToken1Address(tokenAddress)
  //       else setToken2Address(tokenAddress)
  //     } else {
  //       alert('Connect your wallet first')
  //     }
  //   },
  //   [walletClient, address]
  // )

  const mintToken:
    | React.MouseEventHandler<HTMLButtonElement>
    | ((index: number) => React.MouseEventHandler<HTMLButtonElement>) = useCallback(
    (index: number) => async () => {
      console.log('Minting ERC20 token')
      if (walletClient != undefined && address != undefined) {
        let tokenAddress = token1Address
        if (index == 2) tokenAddress = token2Address
        const { request } = await publicClient.simulateContract({
          account: address,
          abi: usdcABI,
          address: tokenAddress as Address,
          functionName: 'mint',
          args: [address, parseUnits('1000', 6)],
        })
        await walletClient.writeContract(request)
      } else {
        alert('Connect your wallet first')
      }
    },
    [publicClient, walletClient, address]
  )

  async function addLiquidity() {
    console.log('Approving tokens before adding liquidity')
    if (walletClient != undefined && address != undefined) {
      //check allowance of the USDC ERC20 token and approve if needed

      const allowance = await publicClient.readContract({
        account: address,
        abi: usdcABI,
        address: token1Address as Address,
        functionName: 'allowance',
        args: [address, uniswapRouter],
      })

      console.log('Allowance of token1: ' + allowance)

      const allowance2 = await publicClient.readContract({
        account: address,
        abi: usdcABI,
        address: token1Address as Address,
        functionName: 'allowance',
        args: [address, uniswapRouter],
      })

      console.log('Allowance of token2: ' + allowance2)

      if (allowance < parseUnits(token1Input.toString(), 6)) {
        const { request: approve1 } = await publicClient.simulateContract({
          account: address,
          abi: usdcABI,
          address: token1Address as Address,
          functionName: 'approve',
          args: [uniswapRouter, parseUnits(token1Input.toString(), 6)],
        })
        walletClient.writeContract(approve1)
      }

      if (allowance2 < parseUnits(token2Input.toString(), 6)) {
        const { request: approve2 } = await publicClient.simulateContract({
          account: address,
          abi: usdcABI,
          address: token2Address as Address,
          functionName: 'approve',
          args: [uniswapRouter, parseUnits(token2Input.toString(), 6)],
        })
        walletClient.writeContract(approve2)
      }

      console.log('Adding liquidity')
    } else {
      alert('Connect your wallet first')
    }
  }

  return (
    <>
      <br />
      {/*<button onClick={deployToken(1)} className='btn btn-accent ml-4'>*/}
      {/*  Deploy Token 1*/}
      {/*</button>*/}

      {/*<button onClick={deployToken(2)} className='btn btn-accent ml-4'>*/}
      {/*  Deploy Token 2*/}
      {/*</button>*/}

      <button onClick={mintToken(1)} className='btn btn-accent ml-4'>
        Mint Token 1
      </button>

      <button onClick={mintToken(2)} className='btn btn-accent ml-4'>
        Mint Token 2
      </button>

      <p className={'mt-4'}>Current Token 1 Balance: {token1Balance.data?.formatted}</p>
      <p>Current Token 2 Balance: {token2Balance.data?.formatted}</p>

      <p className='text-lg mt-4'>Token 1</p>

      <input type='text' value={token1Address} className='input input-bordered input-primary w-full max-w-md' />
      <input
        type='number'
        value={token1Input}
        placeholder='0.0'
        onChange={handleToken1InputChange}
        className='input input-bordered input-secondary w-full max-w-xs mt-2'
      />

      <br />
      <br />

      <p className='text-lg'>Token 2</p>
      <input type='text' value={token2Address} className='input input-bordered input-primary w-full max-w-md' />
      <input
        type='number'
        value={token2Input}
        placeholder='0.0'
        onChange={handleToken2InputChange}
        className='input input-bordered input-secondary w-full max-w-xs mt-2'
      />

      <br />
      <br />

      <button onClick={addLiquidity} className='btn btn-secondary mr-4'>
        Add Liquidity
      </button>

      <button className='btn btn-primary'>Swap</button>
    </>
  )
}
